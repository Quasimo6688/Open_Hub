<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brick Breaker Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }

        canvas {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <script>
        let ball;
        let paddle;
        let bricks = [];
        let brickW = 60;
        let brickH = 30;
        let playingGame = true; // 游戏是否正在进行
        let youWin = false; // 是否赢得游戏
        let winText; // 获胜时的文本
        let colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33FF', '#FFFF33'];
        let level = 1; // 游戏关卡
        let balls = []; // 存储所有的小球

        function setup() {
            createCanvas(600, 800);
            ball = new Ball();
            balls.push(ball);
            paddle = new Paddle();
            winText = createP('');
            winText.position(10, 830);

            let totalBricksWidth = brickW * 10;
            let startX = (width - totalBricksWidth) / 2;

            bricks = [];
            for (let j = 0; j < 5 + level; j++) {
                for (let i = 0; i < 10; i++) {
                    let hits = 2 + (j * 2); // 基础碰撞次数为2，每后面一层累加2次
                    bricks.push(new Brick(createVector(startX + brickW * i, 25 + brickH * j), colors[j % colors.length], hits));
                }
            }
        }

        function draw() {
            background(220);

            for (let b of balls) {
                b.display();
                if (playingGame) {
                    b.update();
                }
            }
            paddle.display();
            if (playingGame) {
                paddle.update();
            }
            for (let i = 0; i < bricks.length; i++) {
                bricks[i].display();
            }

            checkCollisions();

            displayWinText();
        }

        function Ball() {
            this.position = createVector(width / 2, height / 2);
            this.direction = createVector(random(-1, 1), random(-1, 1));
            this.speed = 8;
            this.radius = 8;

            this.display = function () {
                fill(0);
                ellipse(this.position.x, this.position.y, this.radius * 2, this.radius * 2);
            };

            this.update = function () {
                this.position.x += this.direction.x * this.speed;
                this.position.y += this.direction.y * this.speed;

                if (this.position.x > width - this.radius || this.position.x < this.radius) {
                    this.direction.x *= -1;
                }

                if (this.position.y < this.radius) {
                    this.direction.y *= -1;
                }

                if (this.position.y > height) {
                    let index = balls.indexOf(this);
                    if (index > -1) {
                        balls.splice(index, 1);
                    }
                }
            };
        }

        function Paddle() {
            this.width = 100;
            this.height = 10;
            this.position = createVector((width - this.width) / 2, height - 50);
            this.isMovingLeft = false;
            this.isMovingRight = false;
            this.speed = 5;

            this.display = function () {
                fill(0);
                rect(this.position.x, this.position.y, this.width, this.height);
            };

            this.update = function () {
                if (this.isMovingRight && this.position.x < width - this.width) {
                    this.position.x += this.speed;
                }
                if (this.isMovingLeft && this.position.x > 0) {
                    this.position.x -= this.speed;
                }
            };
        }

        function Brick(position, color, hits) {
            this.position = position;
            this.color = color;
            this.isAlive = true;
            this.hitsToBreak = hits;

            this.display = function () {
                if (this.isAlive) {
                    fill(this.color);
                    rect(this.position.x, this.position.y, brickW, brickH);
                }
            };
        }

        function checkCollisions() {
            for (let b of balls) {
                if (b.position.y + b.radius > paddle.position.y && b.position.y - b.radius < paddle.position.y + paddle.height && b.position.x + b.radius > paddle.position.x && b.position.x - b.radius < paddle.position.x + paddle.width) {
                    b.direction.y *= -1;
                }

                for (let i = 0; i < bricks.length; i++) {
                    if (b.position.y + b.radius > bricks[i].position.y && b.position.y - b.radius < bricks[i].position.y + brickH && b.position.x + b.radius > bricks[i].position.x && b.position.x - b.radius < bricks[i].position.x + brickW && bricks[i].isAlive) {
                        bricks[i].hitsToBreak--;
                        if (bricks[i].hitsToBreak <= 0) {
                            bricks[i].isAlive = false;
                            if (random() < 0.15) { // 15%的几率生成新的小球
                                let newBall = new Ball();
                                newBall.position = createVector(bricks[i].position.x, bricks[i].position.y);
                                balls.push(newBall);
                            }
                        }
                        b.direction.y *= -1;
                    }
                }
            }
        }

        function displayWinText() {
            let allBricksBroken = true;
            for (let i = 0; i < bricks.length; i++) {
                if (bricks[i].isAlive) {
                    allBricksBroken = false;
                    break;
                }
            }
            if (allBricksBroken) {
                youWin = true;
                winText.html('您赢了! 按空格键进入下一关。');
            } else {
                youWin = false;
                winText.html('');
            }
        }

        function keyPressed() {
            if (keyCode === LEFT_ARROW) {
                paddle.isMovingLeft = true;
            } else if (keyCode === RIGHT_ARROW) {
                paddle.isMovingRight = true;
            }

            if (key === ' ') {
                if (youWin) {
                    level++;
                    setup();
                } else {
                    playingGame = !playingGame; // 暂停或继续游戏
                }
            }
        }

        function keyReleased() {
            if (keyCode === LEFT_ARROW) {
                paddle.isMovingLeft = false;
            } else if (keyCode === RIGHT_ARROW) {
                paddle.isMovingRight = false;
            }
        }
    </script>
</body>
</html>
